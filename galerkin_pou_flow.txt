╔═══════════════════════════════════════════════════════════════════════════════╗
║                    GALERKIN PARTITION-OF-UNITY HEAD                           ║
║                   (2D Problem: p=128, dk=64, dv=64)                           ║
╚═══════════════════════════════════════════════════════════════════════════════╝

                                    INPUTS
                                      │
                        ┌─────────────┴─────────────┐
                        │                           │
                   x_enc (B,N,64)              u (B,N,1)
              (encoded positions)         (sensor values)
                        │                           │
                        │                           │
        ┌───────────────┘                           └───────────┐
        │                                                       │
        │                                                       │
        ▼                                                       ▼
 ┏━━━━━━━━━━━━━━━┓                                    ┏━━━━━━━━━━━━━━━━━┓
 ┃  KEY NETWORK  ┃                                    ┃  Concatenate    ┃
 ┃ 64→256→256→64 ┃                                    ┃  [x_enc, u]     ┃
 ┃  98,880 params┃                                    ┃  → (B,N,65)     ┃
 ┗━━━━━━━━━━━━━━━┛                                    ┗━━━━━━━━━━━━━━━━━┛
        │                                                       │
        │                                                       │
        ▼                                                       ▼
   K (B,N,64)                                        ┏━━━━━━━━━━━━━━━━━━┓
        │                                            ┃  VALUE NETWORK   ┃
        │                                            ┃ 65→256→256→64    ┃
        │                                            ┃  99,136 params   ┃
        │                                            ┗━━━━━━━━━━━━━━━━━━┛
        │                                                       │
        │                                                       │
        │                                                       ▼
        │                                                  V (B,N,64)
        │                                                       │
        │                                                       │
        │                    ┏━━━━━━━━━━━━━━━━━┓               │
        │                    ┃ QUERY TOKENS    ┃               │
        │                    ┃ (1,128,64)      ┃               │
        │                    ┃  8,192 params   ┃               │
        │                    ┗━━━━━━━━━━━━━━━━━┛               │
        │                             │                        │
        │                             ▼                        │
        │                      Q (B,128,64)                    │
        │                             │                        │
        │                             │                        │
        └─────────────┬───────────────┘                        │
                      │                                        │
                      ▼                                        │
         ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓                    │
         ┃  ATTENTION SCORES              ┃                    │
         ┃  einsum("bpk,bnk->bpn", Q, K)  ┃                    │
         ┃  ÷ sqrt(64)                    ┃                    │
         ┃  → (B,128,N)                   ┃                    │
         ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛                    │
                      │                                        │
                      ▼                                        │
         ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓            │
         ┃  PARTITION-OF-UNITY SOFTMAX          ┃            │
         ┃  Phi = softmax(scores, dim=1)        ┃            │
         ┃        ↑                              ┃            │
         ┃        └── dim=1 (TOKEN axis!)       ┃            │
         ┃  → (B,128,N)                          ┃            │
         ┃                                       ┃            │
         ┃  Ensures: Σₖ Φ[b,k,i] = 1           ┃            │
         ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛            │
                      │                                        │
                      │                                        │
                      └────────────┬───────────────────────────┘
                                   │
                                   │ (Phi, weights, V)
                                   ▼
              ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
              ┃  GALERKIN QUADRATURE SUM                  ┃
              ┃  pooled = Σᵢ wᵢ · Φ[b,p,i] · V[b,i,d]   ┃
              ┃          ────────────────────────────     ┃
              ┃               Σᵢ wᵢ                      ┃
              ┃  → (B,128,64)                             ┃
              ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                                   │
                                   ▼
              ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
              ┃  RHO TOKEN (output projection)    ┃
              ┃  64→256→1                         ┃
              ┃  16,897 params                    ┃
              ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                                   │
                                   ▼
                              b (B,128,1)
                                   │
                                   │ Branch coefficients
                                   ▼
              ╔═══════════════════════════════════════╗
              ║  To DeepONet synthesis:               ║
              ║  G(u)(y) = Σₖ b[k] ⊙ trunk[k](y)     ║
              ╚═══════════════════════════════════════╝


═══════════════════════════════════════════════════════════════════════════════
PARAMETER BREAKDOWN
═══════════════════════════════════════════════════════════════════════════════

Component              Parameters      Percentage
───────────────────────────────────────────────────────────────────────────────
Key Network            98,880          44.3%
Value Network          99,136          44.4%
Query Tokens            8,192           3.7%
Rho Token              16,897           7.6%
───────────────────────────────────────────────────────────────────────────────
TOTAL                 223,105         100.0%


═══════════════════════════════════════════════════════════════════════════════
KEY DIMENSIONS (2D example: N=100 sensors, M=1000 query points)
═══════════════════════════════════════════════════════════════════════════════

Forward pass tensors (batch_size=32):

x_enc:     (32, 100, 64)     Encoded sensor positions
u:         (32, 100, 1)      Sensor values
K:         (32, 100, 64)     Keys from positions
V:         (32, 100, 64)     Values from (positions, values)
Q:         (32, 128, 64)     Query tokens (p=128 basis functions)
scores:    (32, 128, 100)    Attention logits (tokens × sensors)
Phi:       (32, 128, 100)    PoU coefficients (sums to 1 over tokens)
weights:   (32, 100)         Quadrature weights
pooled:    (32, 128, 64)     Quadrature-integrated values
b:         (32, 128, 1)      Final branch coefficients


═══════════════════════════════════════════════════════════════════════════════
MATHEMATICAL INTERPRETATION
═══════════════════════════════════════════════════════════════════════════════

Tokens represent BASIS FUNCTIONS:  φ₁(x), φ₂(x), ..., φₚ(x)

Sensors are QUADRATURE POINTS:     (x₁,u₁,w₁), (x₂,u₂,w₂), ..., (xₙ,uₙ,wₙ)

Partition-of-Unity at sensor i:    Σₖ Φₖᵢ = 1  (all tokens cover each sensor)

Galerkin coefficient for token k:  cₖ = ∫ φₖ(x)·u(x) dx
                                      ≈ Σᵢ wᵢ·Φₖᵢ·V(xᵢ,uᵢ)
                                        ─────────────────────
                                              Σᵢ wᵢ

This is a LEARNED GALERKIN PROJECTION where:
  - φₖ(x) is implicitly defined via Φₖᵢ (learned basis evaluation)
  - Quadrature weights wᵢ properly scale contributions
  - Normalization makes it scale-invariant w.r.t. number of sensors
